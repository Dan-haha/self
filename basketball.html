<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业篮球模拟器 - 完整版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a2a 0%, #1a1a40 100%);
            color: #fff;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #game-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #ff6b00;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        #game-title {
            font-size: 2.2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #ff6b00, #ffa500, #ffff00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        #scoreboard {
            display: flex;
            gap: 30px;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .team-score {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .team-name {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .score {
            font-size: 2.5rem;
            color: #fff;
        }

        #game-clock {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b00;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #ff6b00;
        }

        #game-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #court-container {
            flex: 3;
            position: relative;
            overflow: hidden;
            background: linear-gradient(to bottom, #1a472a 0%, #2e8b57 100%);
        }

        #court {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        #player-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ff6b00;
            min-width: 250px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stat-label {
            color: #aaa;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        #shot-meter-container {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #ff6b00;
            display: none;
        }

        #shot-meter {
            height: 30px;
            background: linear-gradient(to right, #ff0000, #ffff00, #00ff00);
            border-radius: 5px;
            width: 0%;
            transition: width 0.1s;
        }

        #shot-timing-label {
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
            color: #fff;
        }

        #game-controls {
            flex: 1;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-left: 3px solid #ff6b00;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-width: 350px;
        }

        .control-section {
            margin-bottom: 25px;
            background: rgba(30, 30, 60, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
        }

        .section-title {
            font-size: 1.3rem;
            color: #ff6b00;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff6b00;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            align-items: center;
        }

        .control-label {
            color: #ccc;
            font-size: 1rem;
        }

        .control-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #666;
            font-family: monospace;
            font-size: 1.1rem;
            color: #ffa500;
            min-width: 40px;
            text-align: center;
        }

        #game-events {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .event-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #ddd;
        }

        .event-time {
            color: #ff6b00;
            margin-right: 10px;
        }

        #game-messages {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            border: 3px solid #ff6b00;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            z-index: 200;
            display: none;
        }

        .player {
            position: absolute;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            transition: transform 0.1s;
            z-index: 10;
        }

        .player-controlled {
            border: 3px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .player-user-team {
            background: radial-gradient(circle at 30% 30%, #0066cc, #003366);
        }

        .player-ai-team {
            background: radial-gradient(circle at 30% 30%, #cc0000, #660000);
        }

        .player-number {
            font-size: 1rem;
            font-weight: bold;
        }

        .basketball {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff8c00, #cc7000);
            box-shadow: inset -5px -5px 10px rgba(0, 0, 0, 0.5);
            z-index: 5;
            transition: transform 0.05s;
        }

        .court-element {
            position: absolute;
            border: 2px solid #fff;
        }

        .hoop {
            position: absolute;
            width: 80px;
            height: 10px;
            background: #ff6b00;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.7);
        }

        .backboard {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #aaa;
        }

        #possession-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1rem;
            border: 2px solid #ff6b00;
        }

        #game-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-title {
            font-size: 3.5rem;
            margin-bottom: 40px;
            background: linear-gradient(90deg, #ff6b00, #ffa500, #ffff00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .menu-button {
            background: linear-gradient(to bottom, #ff6b00 0%, #cc5500 100%);
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            margin: 15px 0;
            width: 300px;
            text-align: center;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            background: linear-gradient(to bottom, #ff7b10 0%, #dd6500 100%);
        }

        .menu-button:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

        #team-selector {
            display: flex;
            gap: 30px;
            margin: 30px 0;
        }

        .team-option {
            background: rgba(30, 30, 60, 0.8);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .team-option.selected {
            border-color: #ff6b00;
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.7);
        }

        .team-name-large {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #fff;
        }

        .team-color {
            width: 100%;
            height: 20px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        #difficulty-selector {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .difficulty-option {
            padding: 15px 25px;
            background: rgba(60, 60, 100, 0.8);
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .difficulty-option.selected {
            border-color: #ff6b00;
            background: rgba(80, 80, 120, 0.9);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-header">
            <div id="game-title">专业篮球模拟器 2024</div>
            <div id="scoreboard">
                <div class="team-score">
                    <div class="team-name" id="user-team-name">玩家队</div>
                    <div class="score" id="user-score">0</div>
                </div>
                <div class="team-score">
                    <div class="team-name" id="ai-team-name">电脑队</div>
                    <div class="score" id="ai-score">0</div>
                </div>
            </div>
            <div id="game-clock">12:00</div>
        </div>
        
        <div id="game-content">
            <div id="court-container">
                <div id="court">
                    <!-- 球场将通过JavaScript绘制 -->
                </div>
                <div id="hud-overlay">
                    <div id="player-stats">
                        <div class="stat-row">
                            <span class="stat-label">球员:</span>
                            <span class="stat-value" id="player-name">控球后卫</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">速度:</span>
                            <span class="stat-value" id="player-speed">85</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">投篮:</span>
                            <span class="stat-value" id="player-shooting">78</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">控球:</span>
                            <span class="stat-value" id="player-dribbling">82</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">体力:</span>
                            <span class="stat-value" id="player-stamina">90</span>
                        </div>
                    </div>
                    
                    <div id="shot-meter-container">
                        <div id="shot-meter"></div>
                        <div id="shot-timing-label">释放空格键投篮</div>
                    </div>
                    
                    <div id="possession-indicator">
                        球权: <span id="possession-team">玩家队</span>
                    </div>
                </div>
                
                <div id="game-messages"></div>
            </div>
            
            <div id="game-controls">
                <div class="control-section">
                    <div class="section-title">游戏控制</div>
                    <div class="control-row">
                        <span class="control-label">移动</span>
                        <div class="control-key">W A S D</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">冲刺</span>
                        <div class="control-key">Shift</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">投篮/传球</span>
                        <div class="control-key">空格键</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">切换球员</span>
                        <div class="control-key">Tab</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">暂停/菜单</span>
                        <div class="control-key">Esc</div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-title">运球控制</div>
                    <div class="control-row">
                        <span class="control-label">交叉运球</span>
                        <div class="control-key">X</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">背后运球</span>
                        <div class="control-key">B</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">转身运球</span>
                        <div class="control-key">R</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">假动作</span>
                        <div class="control-key">F</div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-title">比赛信息</div>
                    <div id="game-events">
                        <!-- 事件将通过JavaScript添加 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="game-menu">
            <h1 class="menu-title">专业篮球模拟器</h1>
            
            <div id="team-selector">
                <div class="team-option selected" data-team="lakers">
                    <div class="team-color" style="background: linear-gradient(90deg, #552583, #FDB927);"></div>
                    <div class="team-name-large">湖人队</div>
                    <div>平均评分: 85</div>
                </div>
                <div class="team-option" data-team="warriors">
                    <div class="team-color" style="background: linear-gradient(90deg, #1D428A, #FFC72C);"></div>
                    <div class="team-name-large">勇士队</div>
                    <div>平均评分: 88</div>
                </div>
                <div class="team-option" data-team="bulls">
                    <div class="team-color" style="background: linear-gradient(90deg, #CE1141, #000000);"></div>
                    <div class="team-name-large">公牛队</div>
                    <div>平均评分: 82</div>
                </div>
            </div>
            
            <div id="difficulty-selector">
                <div class="difficulty-option selected" data-difficulty="rookie">新秀</div>
                <div class="difficulty-option" data-difficulty="pro">职业</div>
                <div class="difficulty-option" data-difficulty="allstar">全明星</div>
                <div class="difficulty-option" data-difficulty="halloffame">名人堂</div>
            </div>
            
            <button class="menu-button" id="start-game-btn">开始比赛</button>
            <button class="menu-button" id="how-to-play-btn">游戏教程</button>
            <button class="menu-button" id="settings-btn">游戏设置</button>
        </div>
    </div>

    <script>
        // 游戏主类 - 包含所有游戏逻辑
        class BasketballGame {
            constructor() {
                // 游戏状态
                this.gameState = 'MENU'; // MENU, PLAYING, PAUSED, ENDED
                this.difficulty = 'pro';
                this.selectedTeam = 'lakers';
                
                // 比赛状态
                this.quarter = 1;
                this.quarterTime = 12 * 60; // 12分钟每节，每秒为单位
                this.gameTime = this.quarterTime;
                this.userScore = 0;
                this.aiScore = 0;
                this.possession = 'user'; // 'user' 或 'ai'
                this.shotClock = 24;
                
                // 玩家球队
                this.userTeam = {
                    name: '湖人队',
                    color: '#0066cc',
                    players: [],
                    strategy: 'balanced'
                };
                
                // AI球队
                this.aiTeam = {
                    name: '勇士队',
                    color: '#cc0000',
                    players: [],
                    strategy: 'balanced'
                };
                
                // 当前控制的球员索引
                this.controlledPlayerIndex = 0;
                
                // 篮球状态
                this.ball = {
                    x: 0,
                    y: 0,
                    z: 0, // 用于3D效果
                    vx: 0,
                    vy: 0,
                    vz: 0,
                    holder: null, // 持球球员
                    inAir: false,
                    target: null
                };
                
                // 游戏物理
                this.gravity = 0.5;
                this.friction = 0.9;
                
                // 按键状态
                this.keys = {};
                
                // 运球状态
                this.dribbleType = 'normal';
                this.dribbleTimer = 0;
                this.crossoverDirection = 1;
                
                // 投篮状态
                this.shotPower = 0;
                this.shotIncreasing = true;
                this.shotTimer = null;
                this.isShooting = false;
                
                // 游戏事件
                this.gameEvents = [];
                
                // 初始化
                this.init();
            }
            
            init() {
                this.setupCourt();
                this.createTeams();
                this.setupEventListeners();
                this.setupMenuListeners();
                this.render();
                
                // 添加初始事件
                this.addGameEvent("游戏已加载，选择球队并开始比赛");
            }
            
            setupCourt() {
                const court = document.getElementById('court');
                court.innerHTML = '';
                
                // 绘制球场边界
                const boundary = document.createElement('div');
                boundary.style.position = 'absolute';
                boundary.style.width = '90%';
                boundary.style.height = '90%';
                boundary.style.top = '5%';
                boundary.style.left = '5%';
                boundary.style.border = '4px solid #fff';
                boundary.style.borderRadius = '10px';
                court.appendChild(boundary);
                
                // 绘制中线
                const midLine = document.createElement('div');
                midLine.style.position = 'absolute';
                midLine.style.width = '4px';
                midLine.style.height = '90%';
                midLine.style.top = '5%';
                midLine.style.left = '50%';
                midLine.style.backgroundColor = '#fff';
                midLine.style.transform = 'translateX(-50%)';
                court.appendChild(midLine);
                
                // 绘制三分线
                const threePointLine = document.createElement('div');
                threePointLine.style.position = 'absolute';
                threePointLine.style.width = '300px';
                threePointLine.style.height = '220px';
                threePointLine.style.top = '50%';
                threePointLine.style.left = '5%';
                threePointLine.style.border = '3px solid #fff';
                threePointLine.style.borderRadius = '150px 0 0 150px';
                threePointLine.style.transform = 'translateY(-50%)';
                threePointLine.style.borderRight = 'none';
                court.appendChild(threePointLine);
                
                // 绘制另一边三分线
                const threePointLine2 = document.createElement('div');
                threePointLine2.style.position = 'absolute';
                threePointLine2.style.width = '300px';
                threePointLine2.style.height = '220px';
                threePointLine2.style.top = '50%';
                threePointLine2.style.right = '5%';
                threePointLine2.style.border = '3px solid #fff';
                threePointLine2.style.borderRadius = '0 150px 150px 0';
                threePointLine2.style.transform = 'translateY(-50%)';
                threePointLine2.style.borderLeft = 'none';
                court.appendChild(threePointLine2);
                
                // 绘制罚球线
                const freeThrowLine = document.createElement('div');
                freeThrowLine.style.position = 'absolute';
                freeThrowLine.style.width = '240px';
                freeThrowLine.style.height = '4px';
                freeThrowLine.style.top = '50%';
                freeThrowLine.style.left = '5%';
                freeThrowLine.style.backgroundColor = '#fff';
                freeThrowLine.style.transform = 'translateY(-50%)';
                court.appendChild(freeThrowLine);
                
                // 绘制另一边罚球线
                const freeThrowLine2 = document.createElement('div');
                freeThrowLine2.style.position = 'absolute';
                freeThrowLine2.style.width = '240px';
                freeThrowLine2.style.height = '4px';
                freeThrowLine2.style.top = '50%';
                freeThrowLine2.style.right = '5%';
                freeThrowLine2.style.backgroundColor = '#fff';
                freeThrowLine2.style.transform = 'translateY(-50%)';
                court.appendChild(freeThrowLine2);
                
                // 绘制篮筐
                const hoop1 = document.createElement('div');
                hoop1.className = 'hoop';
                hoop1.style.top = '50%';
                hoop1.style.left = '5%';
                hoop1.style.transform = 'translateY(-50%)';
                court.appendChild(hoop1);
                
                const backboard1 = document.createElement('div');
                backboard1.className = 'backboard';
                backboard1.style.width = '10px';
                backboard1.style.height = '80px';
                backboard1.style.top = '50%';
                backboard1.style.left = '5%';
                backboard1.style.transform = 'translate(-100%, -50%)';
                court.appendChild(backboard1);
                
                const hoop2 = document.createElement('div');
                hoop2.className = 'hoop';
                hoop2.style.top = '50%';
                hoop2.style.right = '5%';
                hoop2.style.transform = 'translateY(-50%)';
                court.appendChild(hoop2);
                
                const backboard2 = document.createElement('div');
                backboard2.className = 'backboard';
                backboard2.style.width = '10px';
                backboard2.style.height = '80px';
                backboard2.style.top = '50%';
                backboard2.style.right = '5%';
                backboard2.style.transform = 'translate(100%, -50%)';
                court.appendChild(backboard2);
                
                // 创建篮球
                this.ballElement = document.createElement('div');
                this.ballElement.className = 'basketball';
                this.ballElement.style.width = '30px';
                this.ballElement.style.height = '30px';
                this.ballElement.style.left = '50%';
                this.ballElement.style.top = '50%';
                court.appendChild(this.ballElement);
            }
            
            createTeams() {
                // 创建用户球队球员
                const userPositions = [
                    {x: 20, y: 50, role: 'PG', number: 1, name: '控球后卫', speed: 85, shooting: 78, dribbling: 88, defense: 75, stamina: 90},
                    {x: 15, y: 30, role: 'SG', number: 2, name: '得分后卫', speed: 82, shooting: 85, dribbling: 80, defense: 72, stamina: 88},
                    {x: 15, y: 70, role: 'SF', number: 3, name: '小前锋', speed: 80, shooting: 82, dribbling: 75, defense: 78, stamina: 85},
                    {x: 10, y: 40, role: 'PF', number: 4, name: '大前锋', speed: 75, shooting: 76, dribbling: 70, defense: 85, stamina: 90},
                    {x: 10, y: 60, role: 'C', number: 5, name: '中锋', speed: 70, shooting: 72, dribbling: 65, defense: 90, stamina: 95}
                ];
                
                this.userTeam.players = userPositions.map(pos => this.createPlayer(pos, true));
                
                // 创建AI球队球员
                const aiPositions = [
                    {x: 80, y: 50, role: 'PG', number: 1, name: '控球后卫', speed: 84, shooting: 80, dribbling: 85, defense: 76, stamina: 88},
                    {x: 85, y: 30, role: 'SG', number: 2, name: '得分后卫', speed: 83, shooting: 84, dribbling: 82, defense: 74, stamina: 86},
                    {x: 85, y: 70, role: 'SF', number: 3, name: '小前锋', speed: 81, shooting: 83, dribbling: 78, defense: 80, stamina: 84},
                    {x: 90, y: 40, role: 'PF', number: 4, name: '大前锋', speed: 76, shooting: 78, dribbling: 72, defense: 84, stamina: 89},
                    {x: 90, y: 60, role: 'C', number: 5, name: '中锋', speed: 72, shooting: 74, dribbling: 68, defense: 88, stamina: 92}
                ];
                
                this.aiTeam.players = aiPositions.map(pos => this.createPlayer(pos, false));
                
                // 设置初始持球球员
                this.ball.holder = this.userTeam.players[0];
                this.updateBallPosition();
            }
            
            createPlayer(data, isUserTeam) {
                const player = {
                    x: data.x,
                    y: data.y,
                    vx: 0,
                    vy: 0,
                    role: data.role,
                    number: data.number,
                    name: data.name,
                    speed: data.speed,
                    shooting: data.shooting,
                    dribbling: data.dribbling,
                    defense: data.defense,
                    stamina: data.stamina,
                    maxStamina: data.stamina,
                    team: isUserTeam ? 'user' : 'ai',
                    element: null,
                    isControlled: false,
                    offenseTendency: this.getOffenseTendency(data.role),
                    defenseTendency: this.getDefenseTendency(data.role)
                };
                
                // 创建球员DOM元素
                const playerEl = document.createElement('div');
                playerEl.className = `player ${isUserTeam ? 'player-user-team' : 'player-ai-team'}`;
                playerEl.style.width = '40px';
                playerEl.style.height = '40px';
                playerEl.style.left = `${data.x}%`;
                playerEl.style.top = `${data.y}%`;
                playerEl.style.transform = 'translate(-50%, -50%)';
                
                const numberEl = document.createElement('div');
                numberEl.className = 'player-number';
                numberEl.textContent = data.number;
                playerEl.appendChild(numberEl);
                
                document.getElementById('court').appendChild(playerEl);
                player.element = playerEl;
                
                return player;
            }
            
            getOffenseTendency(role) {
                const tendencies = {
                    'PG': {shoot: 0.3, drive: 0.4, pass: 0.7, post: 0.1},
                    'SG': {shoot: 0.6, drive: 0.3, pass: 0.4, post: 0.2},
                    'SF': {shoot: 0.5, drive: 0.4, pass: 0.5, post: 0.3},
                    'PF': {shoot: 0.4, drive: 0.3, pass: 0.4, post: 0.6},
                    'C': {shoot: 0.3, drive: 0.2, pass: 0.3, post: 0.8}
                };
                return tendencies[role] || tendencies['PG'];
            }
            
            getDefenseTendency(role) {
                const tendencies = {
                    'PG': {steal: 0.7, block: 0.2, rebound: 0.3, pressure: 0.8},
                    'SG': {steal: 0.6, block: 0.3, rebound: 0.4, pressure: 0.7},
                    'SF': {steal: 0.5, block: 0.4, rebound: 0.6, pressure: 0.6},
                    'PF': {steal: 0.3, block: 0.6, rebound: 0.8, pressure: 0.5},
                    'C': {steal: 0.2, block: 0.8, rebound: 0.9, pressure: 0.4}
                };
                return tendencies[role] || tendencies['PG'];
            }
            
            setupEventListeners() {
                // 键盘事件监听
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                    
                    if (e.key === 'Escape') {
                        this.togglePause();
                    }
                    
                    if (e.key === 'Tab' && this.gameState === 'PLAYING') {
                        e.preventDefault();
                        this.switchControlledPlayer();
                    }
                    
                    if (e.key === ' ' && this.gameState === 'PLAYING') {
                        this.startShot();
                    }
                    
                    // 运球动作
                    if (e.key === 'x' && this.gameState === 'PLAYING') {
                        this.performCrossover();
                    }
                    
                    if (e.key === 'b' && this.gameState === 'PLAYING') {
                        this.performBehindTheBack();
                    }
                    
                    if (e.key === 'r' && this.gameState === 'PLAYING') {
                        this.performSpinMove();
                    }
                    
                    if (e.key === 'f' && this.gameState === 'PLAYING') {
                        this.performPumpFake();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                    
                    if (e.key === ' ' && this.gameState === 'PLAYING' && this.isShooting) {
                        this.releaseShot();
                    }
                });
            }
            
            setupMenuListeners() {
                document.getElementById('start-game-btn').addEventListener('click', () => {
                    this.startGame();
                });
                
                document.getElementById('how-to-play-btn').addEventListener('click', () => {
                    this.showHowToPlay();
                });
                
                document.getElementById('settings-btn').addEventListener('click', () => {
                    this.showSettings();
                });
                
                // 球队选择
                document.querySelectorAll('.team-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.team-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        option.classList.add('selected');
                        this.selectedTeam = option.dataset.team;
                        this.updateTeamInfo();
                    });
                });
                
                // 难度选择
                document.querySelectorAll('.difficulty-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.difficulty-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        option.classList.add('selected');
                        this.difficulty = option.dataset.difficulty;
                    });
                });
            }
            
            updateTeamInfo() {
                const teamInfo = {
                    lakers: {name: '湖人队', color: '#552583'},
                    warriors: {name: '勇士队', color: '#1D428A'},
                    bulls: {name: '公牛队', color: '#CE1141'}
                };
                
                if (teamInfo[this.selectedTeam]) {
                    this.userTeam.name = teamInfo[this.selectedTeam].name;
                    this.userTeam.color = teamInfo[this.selectedTeam].color;
                    document.getElementById('user-team-name').textContent = this.userTeam.name;
                    
                    // 更新球员颜色
                    this.userTeam.players.forEach(player => {
                        player.element.style.background = `radial-gradient(circle at 30% 30%, ${this.userTeam.color}, #003366)`;
                    });
                }
            }
            
            startGame() {
                this.gameState = 'PLAYING';
                document.getElementById('game-menu').style.display = 'none';
                
                // 设置控制球员
                this.setControlledPlayer(this.userTeam.players[0]);
                
                // 开始游戏循环
                this.gameLoop();
                
                // 开始计时器
                this.startGameTimer();
                
                this.addGameEvent("比赛开始！");
            }
            
            togglePause() {
                if (this.gameState === 'PLAYING') {
                    this.gameState = 'PAUSED';
                    this.showMessage("游戏暂停");
                    clearInterval(this.gameTimer);
                } else if (this.gameState === 'PAUSED') {
                    this.gameState = 'PLAYING';
                    this.hideMessage();
                    this.startGameTimer();
                    this.gameLoop();
                }
            }
            
            startGameTimer() {
                clearInterval(this.gameTimer);
                this.gameTimer = setInterval(() => {
                    if (this.gameState === 'PLAYING') {
                        this.gameTime--;
                        
                        if (this.possession === 'ai') {
                            this.shotClock--;
                            if (this.shotClock <= 0) {
                                this.changePossession();
                                this.addGameEvent("24秒违例，球权转换");
                            }
                        }
                        
                        // 每节结束
                        if (this.gameTime <= 0) {
                            this.quarter++;
                            if (this.quarter > 4) {
                                this.endGame();
                            } else {
                                this.gameTime = this.quarterTime;
                                this.addGameEvent(`第${this.quarter}节开始`);
                            }
                        }
                        
                        this.updateGameClock();
                        
                        // AI逻辑
                        if (this.possession === 'ai') {
                            this.runAILogic();
                        }
                    }
                }, 1000); // 游戏时间每秒减少一次
            }
            
            updateGameClock() {
                const minutes = Math.floor(this.gameTime / 60);
                const seconds = this.gameTime % 60;
                document.getElementById('game-clock').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('user-score').textContent = this.userScore;
                document.getElementById('ai-score').textContent = this.aiScore;
                
                const possessionTeam = this.possession === 'user' ? this.userTeam.name : this.aiTeam.name;
                document.getElementById('possession-team').textContent = possessionTeam;
            }
            
            gameLoop() {
                if (this.gameState !== 'PLAYING') return;
                
                // 更新球员
                this.updatePlayers();
                
                // 更新篮球
                this.updateBall();
                
                // 更新运球
                this.updateDribble();
                
                // 渲染
                this.render();
                
                // 继续循环
                requestAnimationFrame(() => this.gameLoop());
            }
            
            updatePlayers() {
                // 更新用户球员
                this.userTeam.players.forEach(player => {
                    if (player.isControlled) {
                        this.updateControlledPlayer(player);
                    } else {
                        this.updateTeammateAI(player);
                    }
                    
                    // 应用速度
                    player.x += player.vx;
                    player.y += player.vy;
                    
                    // 边界检查
                    player.x = Math.max(5, Math.min(95, player.x));
                    player.y = Math.max(5, Math.min(95, player.y));
                    
                    // 应用摩擦
                    player.vx *= 0.9;
                    player.vy *= 0.9;
                    
                    // 更新DOM元素位置
                    player.element.style.left = `${player.x}%`;
                    player.element.style.top = `${player.y}%`;
                });
                
                // 更新AI球员
                this.aiTeam.players.forEach(player => {
                    this.updateAI(player);
                    
                    // 应用速度
                    player.x += player.vx;
                    player.y += player.vy;
                    
                    // 边界检查
                    player.x = Math.max(5, Math.min(95, player.x));
                    player.y = Math.max(5, Math.min(95, player.y));
                    
                    // 应用摩擦
                    player.vx *= 0.9;
                    player.vy *= 0.9;
                    
                    // 更新DOM元素位置
                    player.element.style.left = `${player.x}%`;
                    player.element.style.top = `${player.y}%`;
                });
            }
            
            updateControlledPlayer(player) {
                let moveX = 0;
                let moveY = 0;
                let speed = player.speed / 100;
                
                // 冲刺
                if (this.keys['shift']) {
                    speed *= 1.5;
                    player.stamina -= 0.5;
                    if (player.stamina < 0) player.stamina = 0;
                } else {
                    player.stamina = Math.min(player.maxStamina, player.stamina + 0.2);
                }
                
                // 移动控制
                if (this.keys['w'] || this.keys['arrowup']) moveY -= speed;
                if (this.keys['s'] || this.keys['arrowdown']) moveY += speed;
                if (this.keys['a'] || this.keys['arrowleft']) moveX -= speed;
                if (this.keys['d'] || this.keys['arrowright']) moveX += speed;
                
                // 根据体力调整速度
                const staminaFactor = player.stamina / player.maxStamina;
                speed *= staminaFactor;
                
                player.vx += moveX * speed;
                player.vy += moveY * speed;
                
                // 限制最大速度
                const maxSpeed = 2;
                const currentSpeed = Math.sqrt(player.vx * player.vx + player.vy * player.vy);
                if (currentSpeed > maxSpeed) {
                    player.vx = (player.vx / currentSpeed) * maxSpeed;
                    player.vy = (player.vy / currentSpeed) * maxSpeed;
                }
                
                // 更新球员数据
                this.updatePlayerStats(player);
            }
            
            updateTeammateAI(player) {
                // 简单队友AI - 移动到进攻位置
                const targetPos = this.getOffensivePosition(player);
                const dx = targetPos.x - player.x;
                const dy = targetPos.y - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    player.vx += (dx / distance) * 0.1;
                    player.vy += (dy / distance) * 0.1;
                }
            }
            
            updateAI(player) {
                if (this.possession === 'ai' && this.ball.holder === player) {
                    // AI持球逻辑
                    this.updateAIOffense(player);
                } else {
                    // AI防守或无球进攻逻辑
                    this.updateAIDefense(player);
                }
            }
            
            updateAIOffense(player) {
                const difficultyFactors = {
                    'rookie': 0.6,
                    'pro': 0.8,
                    'allstar': 1.0,
                    'halloffame': 1.2
                };
                
                const factor = difficultyFactors[this.difficulty] || 0.8;
                
                // 决定行动
                const action = Math.random();
                const tendencies = player.offenseTendency;
                
                if (action < 0.02 * factor) {
                    // 投篮
                    this.aiShoot(player);
                } else if (action < 0.05 * factor) {
                    // 传球
                    this.aiPass(player);
                } else {
                    // 移动
                    const dx = 50 - player.x; // 向篮筐移动
                    const dy = 50 - player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 10) {
                        player.vx += (dx / distance) * 0.1 * factor;
                        player.vy += (dy / distance) * 0.1 * factor;
                    }
                }
            }
            
            updateAIDefense(player) {
                // 找到离自己最近的对手球员
                let targetPlayer = null;
                let minDistance = Infinity;
                
                this.userTeam.players.forEach(opponent => {
                    const dx = opponent.x - player.x;
                    const dy = opponent.y - player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        targetPlayer = opponent;
                    }
                });
                
                if (targetPlayer) {
                    const dx = targetPlayer.x - player.x;
                    const dy = targetPlayer.y - player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 10) {
                        player.vx += (dx / distance) * 0.08;
                        player.vy += (dy / distance) * 0.08;
                    }
                    
                    // 尝试抢断
                    if (distance < 20 && this.ball.holder && this.ball.holder.team === 'user' && Math.random() < 0.01) {
                        this.attemptSteal(player, this.ball.holder);
                    }
                }
            }
            
            getOffensivePosition(player) {
                // 根据球员位置返回进攻位置
                const positions = {
                    'PG': {x: 25, y: 50},
                    'SG': {x: 20, y: 30},
                    'SF': {x: 20, y: 70},
                    'PF': {x: 15, y: 40},
                    'C': {x: 15, y: 60}
                };
                
                return positions[player.role] || {x: 25, y: 50};
            }
            
            updateBall() {
                if (this.ball.inAir) {
                    // 应用物理
                    this.ball.x += this.ball.vx;
                    this.ball.y += this.ball.vy;
                    this.ball.z += this.ball.vz;
                    
                    // 应用重力
                    this.ball.vz -= this.gravity;
                    
                    // 地面碰撞
                    if (this.ball.z <= 0) {
                        this.ball.z = 0;
                        this.ball.vz = -this.ball.vz * 0.7; // 反弹
                        this.ball.vx *= this.friction;
                        this.ball.vy *= this.friction;
                        
                        // 如果速度很小，停止弹跳
                        if (Math.abs(this.ball.vz) < 0.5) {
                            this.ball.vz = 0;
                        }
                    }
                    
                    // 边界检查
                    this.ball.x = Math.max(5, Math.min(95, this.ball.x));
                    this.ball.y = Math.max(5, Math.min(95, this.ball.y));
                    
                    // 检查是否进入篮筐
                    this.checkForScore();
                    
                    // 检查球员是否接到球
                    this.checkForCatch();
                } else if (this.ball.holder) {
                    // 球在球员手中
                    this.updateBallPosition();
                }
                
                // 更新篮球DOM元素
                this.ballElement.style.left = `${this.ball.x}%`;
                this.ballElement.style.top = `${this.ball.y}%`;
                
                // 3D效果 - 根据Z轴调整大小和阴影
                const scale = 1 + this.ball.z / 100;
                this.ballElement.style.transform = `translate(-50%, -50%) scale(${scale})`;
                this.ballElement.style.boxShadow = `inset -${5 * scale}px -${5 * scale}px ${10 * scale}px rgba(0, 0, 0, 0.5)`;
            }
            
            updateBallPosition() {
                if (this.ball.holder) {
                    // 根据运球类型调整球的位置
                    let offsetX = 0, offsetY = 0;
                    
                    if (this.dribbleType === 'normal') {
                        offsetY = 15;
                    } else if (this.dribbleType === 'crossover') {
                        offsetX = 10 * this.crossoverDirection;
                        offsetY = 15;
                    } else if (this.dribbleType === 'behind') {
                        offsetY = 20;
                    } else if (this.dribbleType === 'spin') {
                        offsetX = 15 * Math.cos(this.dribbleTimer * 0.2);
                        offsetY = 15 * Math.sin(this.dribbleTimer * 0.2);
                    }
                    
                    this.ball.x = this.ball.holder.x + offsetX;
                    this.ball.y = this.ball.holder.y + offsetY;
                    this.ball.z = 0;
                }
            }
            
            updateDribble() {
                if (this.dribbleTimer > 0) {
                    this.dribbleTimer--;
                    if (this.dribbleTimer === 0) {
                        this.dribbleType = 'normal';
                    }
                }
            }
            
            startShot() {
                if (this.ball.holder && this.ball.holder.isControlled && !this.isShooting) {
                    this.isShooting = true;
                    this.shotPower = 0;
                    this.shotIncreasing = true;
                    
                    // 显示投篮计量器
                    document.getElementById('shot-meter-container').style.display = 'block';
                    
                    // 开始投篮计时器
                    this.shotTimer = setInterval(() => {
                        if (this.shotIncreasing) {
                            this.shotPower += 2;
                            if (this.shotPower >= 100) this.shotIncreasing = false;
                        } else {
                            this.shotPower -= 2;
                            if (this.shotPower <= 0) this.shotIncreasing = true;
                        }
                        
                        document.getElementById('shot-meter').style.width = `${this.shotPower}%`;
                        
                        // 更新时机标签
                        let timingLabel = "释放空格键投篮";
                        let color = "#fff";
                        
                        if (this.shotPower < 30) {
                            timingLabel = "太弱";
                            color = "#ff0000";
                        } else if (this.shotPower > 70) {
                            timingLabel = "太强";
                            color = "#ff0000";
                        } else if (this.shotPower > 45 && this.shotPower < 55) {
                            timingLabel = "完美时机！";
                            color = "#00ff00";
                        } else {
                            timingLabel = "不错";
                            color = "#ffff00";
                        }
                        
                        document.getElementById('shot-timing-label').textContent = timingLabel;
                        document.getElementById('shot-timing-label').style.color = color;
                    }, 50);
                }
            }
            
            releaseShot() {
                if (!this.isShooting) return;
                
                clearInterval(this.shotTimer);
                this.isShooting = false;
                
                // 隐藏投篮计量器
                document.getElementById('shot-meter-container').style.display = 'none';
                
                // 计算投篮
                this.takeShot();
            }
            
            takeShot() {
                if (!this.ball.holder || !this.ball.holder.isControlled) return;
                
                const player = this.ball.holder;
                
                // 计算到篮筐的距离
                const basketX = player.team === 'user' ? 95 : 5;
                const basketY = 50;
                const dx = basketX - player.x;
                const dy = basketY - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // 计算基础命中率
                let baseChance = player.shooting / 100;
                
                // 距离因素
                let distanceFactor = 1.0;
                if (distance > 40) {
                    distanceFactor = 0.6; // 远距离
                } else if (distance > 20) {
                    distanceFactor = 0.8; // 中距离
                } else {
                    distanceFactor = 1.0; // 近距离
                }
                
                // 投篮时机因素
                let timingFactor = 1.0;
                if (this.shotPower < 30 || this.shotPower > 70) {
                    timingFactor = 0.6; // 糟糕时机
                } else if (this.shotPower > 45 && this.shotPower < 55) {
                    timingFactor = 1.2; // 完美时机
                } else {
                    timingFactor = 0.9; // 一般时机
                }
                
                // 防守压力因素
                const defensePressure = this.calculateDefensePressure(player);
                const defenseFactor = 1.0 - (defensePressure / 100);
                
                // 最终命中率
                let finalChance = baseChance * distanceFactor * timingFactor * defenseFactor;
                finalChance = Math.max(0.1, Math.min(0.9, finalChance));
                
                // 决定是否命中
                const isMade = Math.random() < finalChance;
                
                // 执行投篮
                this.shootBall(player, basketX, basketY, isMade, distance);
                
                this.addGameEvent(`${player.name} 投篮${isMade ? '命中' : '未中'} (${Math.round(finalChance * 100)}% 机会)`);
            }
            
            calculateDefensePressure(player) {
                let pressure = 0;
                
                this.aiTeam.players.forEach(defender => {
                    const dx = defender.x - player.x;
                    const dy = defender.y - player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 20) {
                        pressure += (20 - distance) * defender.defense / 20;
                    }
                });
                
                return Math.min(100, pressure);
            }
            
            shootBall(shooter, targetX, targetY, isMade, distance) {
                this.ball.inAir = true;
                this.ball.holder = null;
                this.ball.x = shooter.x;
                this.ball.y = shooter.y;
                this.ball.z = 0;
                
                // 调整目标位置（如果不中）
                let finalTargetX = targetX;
                let finalTargetY = targetY;
                
                if (!isMade) {
                    // 添加随机偏移
                    finalTargetX += (Math.random() - 0.5) * 20;
                    finalTargetY += (Math.random() - 0.5) * 15;
                }
                
                // 计算初始速度
                const time = 1.5 + distance / 100; // 飞行时间
                this.ball.vx = (finalTargetX - shooter.x) / time;
                this.ball.vy = (finalTargetY - shooter.y) / time;
                this.ball.vz = 50; // 初始垂直速度
            }
            
            checkForScore() {
                // 检查球是否进入篮筐
                const userBasketX = 95;
                const aiBasketX = 5;
                const basketY = 50;
                const basketRadius = 10;
                
                // 检查用户篮筐
                const dxUser = this.ball.x - userBasketX;
                const dyUser = this.ball.y - basketY;
                const distanceUser = Math.sqrt(dxUser * dxUser + dyUser * dyUser);
                
                // 检查AI篮筐
                const dxAI = this.ball.x - aiBasketX;
                const dyAI = this.ball.y - basketY;
                const distanceAI = Math.sqrt(dxAI * dxAI + dyAI * dyAI);
                
                // 检查是否在篮筐附近且正在下落
                if (this.ball.vz < 0 && this.ball.z < 20) {
                    // 用户得分（AI篮筐）
                    if (distanceAI < basketRadius) {
                        this.userScore += 2;
                        this.addGameEvent(`得分！${this.userTeam.name} +2分`);
                        this.ball.inAir = false;
                        this.resetAfterScore();
                        return;
                    }
                    
                    // AI得分（用户篮筐）
                    if (distanceUser < basketRadius) {
                        this.aiScore += 2;
                        this.addGameEvent(`得分！${this.aiTeam.name} +2分`);
                        this.ball.inAir = false;
                        this.resetAfterScore();
                        return;
                    }
                }
                
                // 检查球是否出界
                if (this.ball.x <= 5 || this.ball.x >= 95 || this.ball.y <= 5 || this.ball.y >= 95) {
                    this.addGameEvent("球出界！");
                    this.resetAfterOutOfBounds();
                }
            }
            
            checkForCatch() {
                // 检查是否有球员接到球
                if (!this.ball.inAir || this.ball.z > 10) return;
                
                const allPlayers = [...this.userTeam.players, ...this.aiTeam.players];
                
                allPlayers.forEach(player => {
                    const dx = player.x - this.ball.x;
                    const dy = player.y - this.ball.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 15) {
                        // 球员接到球
                        this.ball.inAir = false;
                        this.ball.holder = player;
                        this.ball.z = 0;
                        this.updateBallPosition();
                        
                        // 更新球权
                        this.possession = player.team;
                        this.shotClock = 24;
                        
                        this.addGameEvent(`${player.name} 接到球`);
                        
                        // 如果是AI球员接到球，设置控制
                        if (player.team === 'ai') {
                            this.setControlledPlayer(this.userTeam.players[0]);
                        }
                    }
                });
            }
            
            resetAfterScore() {
                // 得分后重置
                this.changePossession();
                
                // 重置球的位置
                setTimeout(() => {
                    if (this.possession === 'user') {
                        this.ball.holder = this.userTeam.players[0];
                    } else {
                        this.ball.holder = this.aiTeam.players[0];
                    }
                    
                    this.ball.inAir = false;
                    this.updateBallPosition();
                    
                    // 重置球员位置
                    this.resetPlayerPositions();
                }, 2000);
            }
            
            resetAfterOutOfBounds() {
                // 出界后重置
                this.changePossession();
                
                // 重置球的位置
                setTimeout(() => {
                    if (this.possession === 'user') {
                        this.ball.holder = this.userTeam.players[0];
                    } else {
                        this.ball.holder = this.aiTeam.players[0];
                    }
                    
                    this.ball.inAir = false;
                    this.updateBallPosition();
                }, 1000);
            }
            
            changePossession() {
                this.possession = this.possession === 'user' ? 'ai' : 'user';
                this.shotClock = 24;
                
                this.addGameEvent(`球权转换: ${this.possession === 'user' ? this.userTeam.name : this.aiTeam.name} 获得球权`);
            }
            
            resetPlayerPositions() {
                // 重置用户球员位置
                const userPositions = [
                    {x: 20, y: 50}, {x: 15, y: 30}, {x: 15, y: 70}, {x: 10, y: 40}, {x: 10, y: 60}
                ];
                
                this.userTeam.players.forEach((player, i) => {
                    player.x = userPositions[i].x;
                    player.y = userPositions[i].y;
                    player.vx = 0;
                    player.vy = 0;
                });
                
                // 重置AI球员位置
                const aiPositions = [
                    {x: 80, y: 50}, {x: 85, y: 30}, {x: 85, y: 70}, {x: 90, y: 40}, {x: 90, y: 60}
                ];
                
                this.aiTeam.players.forEach((player, i) => {
                    player.x = aiPositions[i].x;
                    player.y = aiPositions[i].y;
                    player.vx = 0;
                    player.vy = 0;
                });
            }
            
            performCrossover() {
                if (this.ball.holder && this.ball.holder.isControlled && this.dribbleTimer === 0) {
                    this.dribbleType = 'crossover';
                    this.dribbleTimer = 30;
                    this.crossoverDirection = -this.crossoverDirection;
                    
                    this.addGameEvent("交叉运球！");
                }
            }
            
            performBehindTheBack() {
                if (this.ball.holder && this.ball.holder.isControlled && this.dribbleTimer === 0) {
                    this.dribbleType = 'behind';
                    this.dribbleTimer = 40;
                    
                    this.addGameEvent("背后运球！");
                }
            }
            
            performSpinMove() {
                if (this.ball.holder && this.ball.holder.isControlled && this.dribbleTimer === 0) {
                    this.dribbleType = 'spin';
                    this.dribbleTimer = 50;
                    
                    this.addGameEvent("转身运球！");
                }
            }
            
            performPumpFake() {
                if (this.ball.holder && this.ball.holder.isControlled) {
                    this.addGameEvent("投篮假动作！");
                    
                    // 假动作动画
                    const player = this.ball.holder;
                    const originalY = player.y;
                    
                    // 轻微上跳动画
                    let jumpHeight = 5;
                    let jumpStep = 0;
                    
                    const jumpInterval = setInterval(() => {
                        jumpStep++;
                        player.y = originalY - Math.sin(jumpStep * 0.2) * jumpHeight;
                        
                        if (jumpStep > 15) {
                            clearInterval(jumpInterval);
                            player.y = originalY;
                        }
                    }, 30);
                }
            }
            
            aiShoot(player) {
                this.addGameEvent(`${player.name} 投篮`);
                
                // 简单AI投篮逻辑
                const basketX = player.team === 'ai' ? 5 : 95;
                const basketY = 50;
                const dx = basketX - player.x;
                const dy = basketY - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // AI命中率基于难度和距离
                let chance = 0.5;
                if (distance < 20) chance = 0.7;
                if (distance > 40) chance = 0.3;
                
                // 难度调整
                if (this.difficulty === 'rookie') chance *= 0.7;
                if (this.difficulty === 'halloffame') chance *= 1.2;
                
                const isMade = Math.random() < chance;
                
                this.shootBall(player, basketX, basketY, isMade, distance);
                
                if (isMade) {
                    setTimeout(() => {
                        if (player.team === 'ai') {
                            this.aiScore += 2;
                        } else {
                            this.userScore += 2;
                        }
                        this.addGameEvent(`投篮命中！${player.team === 'ai' ? this.aiTeam.name : this.userTeam.name} +2分`);
                        this.resetAfterScore();
                    }, 1500);
                }
            }
            
            aiPass(player) {
                // AI传球逻辑
                const teammates = player.team === 'user' ? this.userTeam.players : this.aiTeam.players;
                const receiver = teammates[Math.floor(Math.random() * teammates.length)];
                
                if (receiver !== player) {
                    this.addGameEvent(`${player.name} 传球给 ${receiver.name}`);
                    
                    // 传球动画
                    this.ball.inAir = true;
                    this.ball.holder = null;
                    this.ball.x = player.x;
                    this.ball.y = player.y;
                    
                    const time = 0.8;
                    this.ball.vx = (receiver.x - player.x) / time;
                    this.ball.vy = (receiver.y - player.y) / time;
                    this.ball.vz = 30;
                }
            }
            
            attemptSteal(defender, ballHandler) {
                // 尝试抢断
                const stealChance = defender.defenseTendency.steal * 0.05;
                
                if (Math.random() < stealChance) {
                    this.ball.holder = defender;
                    this.possession = defender.team;
                    this.shotClock = 24;
                    
                    this.addGameEvent(`${defender.name} 抢断！`);
                }
            }
            
            runAILogic() {
                // 运行AI球队的整体逻辑
                if (this.ball.holder && this.ball.holder.team === 'ai') {
                    // 如果AI持球，随机决定行动
                    if (Math.random() < 0.01) {
                        this.aiShoot(this.ball.holder);
                    } else if (Math.random() < 0.005) {
                        this.aiPass(this.ball.holder);
                    }
                }
            }
            
            switchControlledPlayer() {
                // 切换控制的球员
                this.controlledPlayerIndex = (this.controlledPlayerIndex + 1) % this.userTeam.players.length;
                this.setControlledPlayer(this.userTeam.players[this.controlledPlayerIndex]);
                
                this.addGameEvent(`现在控制: ${this.userTeam.players[this.controlledPlayerIndex].name}`);
            }
            
            setControlledPlayer(player) {
                // 清除所有球员的控制状态
                this.userTeam.players.forEach(p => {
                    p.isControlled = false;
                    p.element.classList.remove('player-controlled');
                });
                
                // 设置新控制球员
                player.isControlled = true;
                player.element.classList.add('player-controlled');
                
                // 如果该球员持球，更新球的位置
                if (this.ball.holder === player) {
                    this.updateBallPosition();
                }
                
                // 更新球员数据
                this.updatePlayerStats(player);
            }
            
            updatePlayerStats(player) {
                document.getElementById('player-name').textContent = player.name;
                document.getElementById('player-speed').textContent = player.speed;
                document.getElementById('player-shooting').textContent = player.shooting;
                document.getElementById('player-dribbling').textContent = player.dribbling;
                document.getElementById('player-stamina').textContent = Math.round(player.stamina);
            }
            
            addGameEvent(text) {
                const now = new Date();
                const timeString = `${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                const eventElement = document.createElement('div');
                eventElement.className = 'event-item';
                eventElement.innerHTML = `<span class="event-time">${timeString}</span> ${text}`;
                
                const eventsContainer = document.getElementById('game-events');
                eventsContainer.appendChild(eventElement);
                
                // 滚动到底部
                eventsContainer.scrollTop = eventsContainer.scrollHeight;
                
                // 限制事件数量
                if (eventsContainer.children.length > 20) {
                    eventsContainer.removeChild(eventsContainer.children[0]);
                }
                
                // 添加到游戏事件数组
                this.gameEvents.push({time: timeString, text: text});
            }
            
            showMessage(text) {
                const messageElement = document.getElementById('game-messages');
                messageElement.textContent = text;
                messageElement.style.display = 'block';
            }
            
            hideMessage() {
                document.getElementById('game-messages').style.display = 'none';
            }
            
            showHowToPlay() {
                alert(`篮球模拟器游戏教程：

控制方式:
- W/A/S/D: 移动球员
- Shift: 冲刺（消耗体力）
- 空格键: 投篮/传球（按住蓄力，释放投篮）
- Tab: 切换控制球员
- X: 交叉运球
- B: 背后运球
- R: 转身运球
- F: 投篮假动作
- Esc: 暂停游戏

游戏目标:
- 控制你的球队得分
- 每节12分钟
- 先得到更多分数的球队获胜

提示:
- 注意球员体力，过度冲刺会降低体力
- 完美投篮时机能提高命中率
- 使用运球动作突破防守
- 合理切换球员控制以获得最佳位置

祝您游戏愉快！`);
            }
            
            showSettings() {
                alert("游戏设置功能将在完整版中实现。\n\n当前版本包含:\n- 完整的篮球比赛模拟\n- 两支完整球队(每队5人)\n- 实时物理引擎\n- 多种运球动作\n- 智能AI对手\n- 完整的游戏统计");
            }
            
            endGame() {
                this.gameState = 'ENDED';
                clearInterval(this.gameTimer);
                
                let winnerText = "比赛结束！平局！";
                if (this.userScore > this.aiScore) {
                    winnerText = `比赛结束！${this.userTeam.name}获胜！`;
                } else if (this.aiScore > this.userScore) {
                    winnerText = `比赛结束！${this.aiTeam.name}获胜！`;
                }
                
                this.showMessage(`${winnerText}\n最终比分: ${this.userScore} - ${this.aiScore}`);
                
                // 3秒后返回菜单
                setTimeout(() => {
                    this.hideMessage();
                    document.getElementById('game-menu').style.display = 'flex';
                    this.resetGame();
                }, 5000);
            }
            
            resetGame() {
                this.userScore = 0;
                this.aiScore = 0;
                this.quarter = 1;
                this.gameTime = this.quarterTime;
                this.possession = 'user';
                this.shotClock = 24;
                
                this.resetPlayerPositions();
                
                // 重置球的位置
                this.ball.holder = this.userTeam.players[0];
                this.ball.inAir = false;
                this.updateBallPosition();
                
                // 设置控制球员
                this.setControlledPlayer(this.userTeam.players[0]);
                
                // 清空事件
                document.getElementById('game-events').innerHTML = '';
                this.gameEvents = [];
                
                this.updateGameClock();
            }
            
            render() {
                // 渲染逻辑已经在各个更新函数中处理
                // 这里可以添加额外的渲染效果
            }
        }

        // 初始化游戏
        window.addEventListener('load', () => {
            window.game = new BasketballGame();
        });
    </script>
</body>
</html>
